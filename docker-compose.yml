services:
  # ========== SPARK MASTER ==========
  spark-master:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: spark-master
    hostname: spark-master
    user: root
    environment:
      - SPARK_MODE=master
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
      - SPARK_USER=spark
      - SPARK_MASTER_REST_ENABLED=true
      - SPARK_MASTER_REST_PORT=6066
    ports:
      - "8080:8080"
      - "7077:7077"
      - "6066:6066"
    volumes:
      - ./data:/app/data
      - ./src:/app/src
      - ./.ivy2:/root/.ivy2
      - spark-master-logs:/opt/spark/logs
    networks:
      - spark-network
    stdin_open: true
    tty: true
    command: >
      bash -c "/opt/spark/sbin/start-master.sh --host 0.0.0.0 --port 7077 --webui-port 8080 --rest-port 6066 && tail -f /dev/null"

  # ========== SPARK WORKER 1 ==========
  spark-worker-1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: spark-worker-1
    hostname: spark-worker-1
    user: root
    depends_on:
      - spark-master
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_MEMORY=1g
      - SPARK_WORKER_CORES=2
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
      - SPARK_USER=spark
    ports:
      - "8081:8081"
      - "7001:7001"
    volumes:
      - ./data:/app/data
      - ./src:/app/src
      - ./.ivy2:/root/.ivy2
      - spark-worker-1-logs:/opt/spark/logs
    networks:
      - spark-network
    stdin_open: true
    tty: true
    command: /bin/bash

  # ========== SPARK WORKER 2 ==========
  spark-worker-2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: spark-worker-2
    hostname: spark-worker-2
    user: root
    depends_on:
      - spark-master
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_MEMORY=1g
      - SPARK_WORKER_CORES=2
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
      - SPARK_USER=spark
    ports:
      - "8082:8082"
      - "7002:7002"
    volumes:
      - ./data:/app/data
      - ./src:/app/src
      - ./.ivy2:/root/.ivy2
      - spark-worker-2-logs:/opt/spark/logs
    networks:
      - spark-network
    stdin_open: true
    tty: true
    command: /bin/bash

  # ========== SPARK WORKER 3 ==========
  spark-worker-3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: spark-worker-3
    hostname: spark-worker-3
    user: root
    depends_on:
      - spark-master
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_MEMORY=1g
      - SPARK_WORKER_CORES=2
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
      - SPARK_USER=spark
    ports:
      - "8083:8083"
      - "7003:7003"
    volumes:
      - ./data:/app/data
      - ./src:/app/src
      - ./.ivy2:/root/.ivy2
      - spark-worker-3-logs:/opt/spark/logs
    networks:
      - spark-network
    stdin_open: true
    tty: true
    command: /bin/bash

  # ========== APPLICATION DRIVER ==========
  app-driver:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: app-driver
    user: root
    depends_on:
      - spark-master
      - spark-worker-1
      - spark-worker-2
      - spark-worker-3
    environment:
      - SPARK_MASTER_URL=spark://spark-master:7077
      - INPUT_PATH=/app/data/raw/bgg-games.json
      - OUTPUT_CSV=/app/data/output/pagerank-results.csv
      - OUTPUT_JSON=/app/data/output/pagerank-results.json
      - PR_TOLERANCE=0.001
      - PR_ITERATIONS=30
      - TOP_K=20
    volumes:
      - ./data:/app/data
      - ./src:/app/src
      - ./.ivy2:/root/.ivy2
      - app-driver-logs:/app/logs
    networks:
      - spark-network
    stdin_open: true
    tty: true
    command: /bin/bash

networks:
  spark-network:
    driver: bridge

volumes:
  spark-master-logs:
  spark-worker-1-logs:
  spark-worker-2-logs:
  spark-worker-3-logs:
  app-driver-logs:
